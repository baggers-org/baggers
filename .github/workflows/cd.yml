name: Deploy
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ develop, master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

defaults:
  run:
    shell: bash



# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  deploy:
    if: ${{ !contains(github.event.commits[0].message, 'chore') }}
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install global dependencies
        run: npm i -g yarn vercel

      - name: Install lerna
        run: yarn add lerna

      - name: Configure Git User
        run: |
          git config --global user.email "cd@baggers.com"
          git config --global user.name "CD Pipeline"

      - name: Install workspace dependencies
        run: yarn --immutable && yarn workspaces focus -A

      - name: Bump develop app version
        if: ${{ github.ref == 'refs/heads/develop' }}
        run: yarn lerna version prerelease --yes

      - name: Bump master app version
        if: ${{ github.ref == 'refs/heads/master' }}
        run: yarn lerna version --conventional-commits --conventional-graduate --yes

      - name: Set build info
        run: |
          echo "BUILD_ALIAS=$(node scripts/buildAliasGenerator.js)" >> $GITHUB_ENV
          echo "BUILD_TIME=$(date)" >> $GITHUB_ENV
          echo "BUILD_VERSION=$(cat lerna.json | jq '.version')" >> $GITHUB_ENV

      - name: Setup env files
        run: |
          envsubst < packages/graphql/.env > packages/graphql/.env.temp
          envsubst < packages/ui/.env > packages/ui/.env.temp
          mv packages/ui/.env.temp packages/ui/.env
          mv packages/graphql/.env.temp packages/graphql/.env
          git update-index --assume-unchanged packages/graphql/.env
          git update-index --assume-unchanged packages/ui/.env

      - name: Build
        run: yarn build || exit 1
        env:
          NODE_ENV: production

      # TODO: remove rm -rf when https://github.com/yarnpkg/berry/issues/3256 is fixed
      - name: Remove development dependencies
        run: |
          yarn workspaces focus --production -A
          rm -rf packages/graphql/node_modules/@baggers/graphql
          rm -rf packages/mongoose/node_modules/@baggers/mongoose
      
      - name: Deploy Backend
        run: yarn workspaces foreach -vpi run deploy

      - name: Deploy UI
      - uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }} # Required
          github-token: ${{ secrets.GITHUB_TOKEN }} #Optional 
          vercel-org-id: ${{ secrets.ORG_ID}}  #Required
          vercel-project-id: ${{ secrets.PROJECT_ID}} #Required 
          working-directory: ./packages/ui
