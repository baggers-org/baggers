FROM node:16.13.0-alpine as base

RUN apk update && apk add git


RUN mkdir /baggers
WORKDIR /baggers

FROM base as base-deps
ADD package.json package-lock.json ./
RUN npm ci
ADD . .

# Build the ui application
FROM base-deps as ui-build
ADD apps/ui ./apps/ui
RUN npm run build ui --configuration=production

FROM base as ui

WORKDIR /baggers-ui
COPY --from=ui-build /baggers/dist/apps/ui  /baggers-ui/

# TODO: we are installing all dependencies in the UI container
# TODO: generate package.json for remix projects, i think i can update
# Nrwl/remix and get this functionality
COPY --from=base-deps baggers/package.json /baggers/package-lock.json  /baggers-ui/
COPY --from=base-deps baggers/node_modules/ /baggers-ui/

#Â TODO: prune dependencies here, its far too slow at the moment as its installing all dependenices again for some reason
CMD ["node", "build/main.js"]